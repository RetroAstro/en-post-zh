> åŸæ–‡åœ°å€ï¼šhttps://medium.com/react-in-depth/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react-e1c04700ef6e
>
> åŸæ–‡ä½œè€…ï¼š[Max Koretskyi aka Wizard](https://github.com/maximusk)

![fiber](./assets/fiber.png)

React æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“ã€‚å®ƒçš„æ ¸å¿ƒåœ¨äºèƒ½å¤Ÿæ£€æµ‹ç»„ä»¶çŠ¶æ€ä¸­çš„å˜åŒ–å¹¶ä¸”èƒ½å°†æ›´æ–°çŠ¶æ€æ˜ å°„åˆ°å±å¹•ä¸Šã€‚åœ¨ React ä¸­æˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹ç§°ä½œ**åè°ƒ**ã€‚å½“æˆ‘ä»¬è°ƒç”¨ `setState` æ–¹æ³•æ—¶ï¼ŒReact ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ `state` æˆ– `props` å˜åŒ–å¹¶åœ¨ UI ä¸Šé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚

React æ–‡æ¡£ç»™å‡ºäº†è¯¥åè°ƒæœºåˆ¶çš„[é«˜åº¦æ¦‚æ‹¬](https://reactjs.org/docs/reconciliation.html)ï¼šReact å…ƒç´ ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€`render` æ–¹æ³•ä»¥åŠç”¨äºç»„ä»¶å­é¡¹çš„ diff ç®—æ³•ã€‚ä» `render` æ–¹æ³•ä¸­è¿”å›çš„ä¸å¯æ”¹å˜çš„ React å…ƒç´ æ ‘é€šå¸¸è¢«ç§°ä½œ â€œvirtual DOMâ€ ã€‚è¿™ä¸ªæœ¯è¯­å¾ˆæ—©å°±å¸®åŠ©äººä»¬ç†è§£äº† React ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†è®¸å¤šå›°æƒ‘ï¼Œå› è€Œè¿™ä¸ªæœ¯è¯­ä¸å†åœ¨ React æ–‡æ¡£ä¸­ä½¿ç”¨ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘åªä¼šç§°å…¶ä¸º React å…ƒç´ æ ‘ã€‚

é™¤äº† React å…ƒç´ æ ‘ï¼Œè¯¥æ¡†æ¶ä¸­è¿˜æœ‰ç”¨æ¥ä¿æŒçŠ¶æ€çš„å†…éƒ¨å®ä¾‹ï¼ˆç»„ä»¶ã€DOM èŠ‚ç‚¹ç­‰ï¼‰æ ‘ã€‚ä» React 16 ç‰ˆæœ¬å¼€å§‹ï¼ŒReact æ¨å‡ºäº†è¯¥å†…éƒ¨å®ä¾‹æ ‘çš„å…¨æ–°å®ç°ä»¥åŠç”¨æ¥ç®¡ç†å®ƒçš„ **Fiber** ç®—æ³•ã€‚å¦‚æœæƒ³è¦äº†è§£ Fiber æ¶æ„æ‰€å¸¦æ¥çš„å¥½å¤„è¯·å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç«  [React æ˜¯æ€æ ·å’Œä¸ºä»€ä¹ˆè¦åœ¨ Fiber ä¸­ä½¿ç”¨é“¾è¡¨](https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7)ã€‚

è¿™æ˜¯æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæ—¨åœ¨è®©ä½ ç†è§£ React ä¸­çš„å†…éƒ¨æ¶æ„ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³æä¾›ä¸€äº›é‡è¦æ¦‚å¿µä»¥åŠä¸ Fiber ç®—æ³•æœ‰å…³æ•°æ®ç»“æ„çš„æ·±å…¥æ¦‚è¿°ã€‚ä¸€æ—¦æˆ‘ä»¬æ‹¥æœ‰äº†è¶³å¤Ÿçš„çŸ¥è¯†å‚¨å¤‡ï¼Œæˆ‘ä»¬å°†ä¼šå¼€å§‹æ¢ç©¶è¯¥ç®—æ³•çš„å†…éƒ¨åŸç†ä»¥åŠé‚£äº›ç”¨äºéå†å’Œå¤„ç† fiber æ ‘çš„é‡è¦å‡½æ•°ã€‚æœ¬ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šå±•ç¤º React æ˜¯å¦‚ä½•æ‰§è¡Œåˆå§‹æ¸²æŸ“å’Œå¤„ç†åç»­ `state` ä¸ `props` æ›´æ–°çš„ã€‚ä»é‚£é‡Œå¼€å§‹æˆ‘ä»¬å°†ç»§ç»­è®¨è®ºè°ƒåº¦å™¨çš„ç»†èŠ‚ï¼Œå³å­åè°ƒè¿‡ç¨‹ï¼Œä»¥åŠæ„å»º `effects` åˆ—è¡¨çš„æœºåˆ¶ã€‚

æˆ‘å°†åœ¨è¿™é‡Œä¸ºä½ æä¾›ä¸€äº›éå¸¸æœ‰æ·±åº¦çš„çŸ¥è¯† ğŸ§™â€ï¼Œæˆ‘é¼“åŠ±ä½ é˜…è¯»å¹¶ç†è§£ Concurrent React çš„å†…éƒ¨å·¥ä½œåŸç†ä»¥åŠå…¶èƒŒåçš„é­”æ³•ã€‚å¦‚æœä½ æƒ³ä¸º React é¡¹ç›®ä½œå‡ºè‡ªå·±çš„è´¡çŒ®ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¹Ÿå°†ä¸ºä½ æä¾›å¾ˆå¥½çš„æŒ‡å¯¼ã€‚æˆ‘ååˆ†çƒ­è¡·äº[é€†å‘å·¥ç¨‹](https://blog.angularindepth.com/level-up-your-reverse-engineering-skills-8f910ae10630)ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸­å°†ä¼šæœ‰å¾ˆå¤šå…³äº React æºç çš„é“¾æ¥ã€‚

æœ¬ç¯‡æ–‡ç« çš„å†…å®¹è‚¯å®šæœ‰å¾ˆå¤šéœ€è¦æ…¢æ…¢ç†è§£çš„åœ°æ–¹ï¼Œå¦‚æœä½ ä¸èƒ½å¤Ÿç«‹å³ç†è§£å…¶ä¸­çš„æŸäº›ä¸œè¥¿ï¼Œä¹Ÿä¸è¦æ„Ÿåˆ°æœ‰å‹åŠ›ã€‚

è™½ç„¶ä¼šå¾ˆè€—è´¹æ—¶é—´ä½†è¿™ä¸€åˆ‡éƒ½æ˜¯å€¼å¾—çš„ã€‚**è¯·æ³¨æ„ä½ ä¸éœ€è¦çŸ¥é“ä»»ä½•å…³äºå¦‚ä½•ä½¿ç”¨ React çš„å†…å®¹ã€‚æœ¬æ–‡è®²è§£çš„æ˜¯ React å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚**

## èƒŒæ™¯

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œåœ¨æœ¬ç³»åˆ—çš„æ–‡ç« ä¸­æˆ‘éƒ½å¯èƒ½æåˆ°å®ƒã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥ç”¨æ¥å¢åŠ å±å¹•ä¸Šæ•°å­—çš„æŒ‰é’®ï¼š

![counter](./assets/counter.gif)

è¿™æ˜¯å®ƒçš„å®ç°ä»£ç ï¼š

```jsx
class ClickCounter extends React.Component {
    constructor(props) {
        super(props);
        this.state = {count: 0};
        this.handleClick = this.handleClick.bind(this);
    }

    handleClick() {
        this.setState((state) => {
            return {count: state.count + 1};
        });
    }


    render() {
        return [
            <button key="1" onClick={this.handleClick}>Update counter</button>,
            <span key="2">{this.state.count}</span>
        ]
    }
}
```

æ­£å¦‚ä½ æ‰€è§ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç»„ä»¶å¹¶ä¸”èƒ½ä» `render` æ–¹æ³•ä¸­è¿”å› `button` å’Œ `span` ä¸¤ä¸ªå­å…ƒç´ ã€‚å½“ä½ ç‚¹å‡»æŒ‰é’®åï¼Œç»„ä»¶ä¸­çš„çŠ¶æ€å°±ä¼šåœ¨å†…éƒ¨è¢«æ›´æ–°ã€‚åè¿‡æ¥ï¼Œè¿™ä¼šå¯¼è‡´ `span` å…ƒç´ ä¸­çš„æ–‡æœ¬æ›´æ–°ã€‚

React ä¼šåœ¨**åè°ƒ**è¿‡ç¨‹ä¸­è¿›è¡Œå¾ˆå¤šæ´»åŠ¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“ä»¥åŠåº”ç”¨ç¨‹åºä¸­çš„ `state` æ›´æ–°å React ä¼šæ‰§è¡Œç›¸åº”çš„é«˜çº§æ“ä½œï¼š

* æ›´æ–° `ClickCounter` ç»„ä»¶ `state` ä¸­çš„ `count` å±æ€§ã€‚
* æ£€ç´¢å¹¶æ¯”è¾ƒ `ClickCounter` ç»„ä»¶çš„å­ä»£å’Œå®ƒä»¬çš„ props
* ä¸º `span` å…ƒç´ æ›´æ–° props

åœ¨åè°ƒè¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰å…¶ä»–ä¾‹å¦‚è°ƒç”¨[ç”Ÿå‘½å‘¨æœŸæ–¹æ³•](https://reactjs.org/docs/react-component.html#updating)å’Œæ›´æ–° [refs](https://reactjs.org/docs/refs-and-the-dom.html) çš„æ“ä½œæ‰§è¡Œã€‚**æ‰€æœ‰çš„è¿™äº›æ´»åŠ¨åœ¨ Fiber æ¶æ„ä¸­è¢«ç»Ÿç§°ä¸º â€œworkâ€ ã€‚** work çš„ç±»å‹é€šå¸¸å–å†³äº React å…ƒç´ çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äº class ç»„ä»¶ï¼ŒReact éœ€è¦åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè€Œå¯¹äºå‡½æ•°ç»„ä»¶å°±ä¸éœ€è¦è¿™æ ·åšã€‚æ­£å¦‚ä½ æ‰€äº†è§£çš„ï¼Œåœ¨ React ä¸­æˆ‘ä»¬æœ‰è®¸å¤šç±»å‹çš„å…ƒç´ ã€‚ä¾‹å¦‚ class ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ï¼Œhost ç»„ä»¶ï¼ˆDOM èŠ‚ç‚¹ï¼‰å’Œ portals ç­‰ç­‰ã€‚React å…ƒç´ çš„ç±»å‹ç”± `createElement` å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰ã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸åœ¨ `render` æ–¹æ³•ä¸­ç”¨æ¥åˆ›å»ºå…ƒç´ ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹æ¢ç©¶ React ä¸­çš„å†…éƒ¨æ´»åŠ¨å’Œä¸»è¦çš„ fiber ç®—æ³•ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†Ÿæ‚‰ä¸€ä¸‹ React å†…éƒ¨ä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚

## ä» React å…ƒç´ åˆ° Fiber èŠ‚ç‚¹

React ä¸­çš„æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªç”¨æ¥å±•ç¤º UI çš„ä¸œè¥¿ï¼Œå®ƒåœ¨ `render` æ–¹æ³•ä¸­è¢«è¿”å›ï¼Œé€šå¸¸è¢«å«åšè§†å›¾æˆ–è€…æ¨¡ç‰ˆã€‚ ä¸‹é¢æ˜¯ `ClickCounter` ç»„ä»¶çš„æ¨¡ç‰ˆï¼š 

```jsx
<button key="1" onClick={this.onClick}>Update counter</button>
<span key="2">{this.state.count}</span>
```

### React å…ƒç´ 

ä¸€æ—¦æ¨¡ç‰ˆè¢« JSX ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸€ç³»åˆ—çš„ React å…ƒç´ ã€‚å®ƒä»¬æ‰æ˜¯ React ç»„ä»¶ä¸­ `render` æ–¹æ³•çœŸæ­£æ‰€è¿”å›çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯ HTML ã€‚ç”±äºæˆ‘ä»¬ä¸ä¸€å®šéœ€è¦ä½¿ç”¨ JSX ï¼Œæ•… `ClickCounter` ç»„ä»¶ä¸­çš„ `render` æ–¹æ³•ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·é‡å†™ï¼š

```jsx
class ClickCounter {
    ...
    render() {
        return [
            React.createElement(
                'button',
                {
                    key: '1',
                    onClick: this.onClick
                },
                'Update counter'
            ),
            React.createElement(
                'span',
                {
                    key: '2'
                },
                this.state.count
            )
        ]
    }
}
```

åœ¨ `render` æ–¹æ³•ä¸­è°ƒç”¨çš„ `React.createElement` å‡½æ•°ä¼šåˆ›å»ºåƒä¸‹é¢è¿™æ ·çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼š

```js

[
    {
        $$typeof: Symbol(react.element),
        type: 'button',
        key: "1",
        props: {
            children: 'Update counter',
            onClick: () => { ... }
        }
    },
    {
        $$typeof: Symbol(react.element),
        type: 'span',
        key: "2",
        props: {
            children: 0
        }
    }

```

å¯ä»¥çœ‹åˆ° React å°† **[$$typeof](https://overreacted.io/why-do-react-elements-have-typeof-property/)** å±æ€§æ·»åŠ åˆ°è¿™äº›å¯¹è±¡ä¸Šï¼Œä»¥ä¾¿ç”¨æ¥å”¯ä¸€æ ‡è¯† React å…ƒç´ ã€‚ç„¶åæˆ‘ä»¬æœ‰åƒ **`type`** ã€**`key`** å’Œ **`props`** è¿™äº›ç”¨æ¥æè¿°å…ƒç´ çš„å±æ€§ã€‚è¿™äº›å€¼æ¥è‡ªå½“è°ƒç”¨ **`React.createElement`** å‡½æ•°æ—¶ä¼ é€’çš„å‚æ•°ã€‚è¯·æ³¨æ„ React æ˜¯å¦‚ä½•å°†æ–‡æœ¬å†…å®¹è¡¨ç¤ºä¸º **`span`** å’Œ **`button`** èŠ‚ç‚¹çš„å­é¡¹çš„ã€‚è¿˜æœ‰ä¸ºä»€ä¹ˆç‚¹å‡»äº‹ä»¶ä¼šä½œä¸º **`button`** å…ƒç´ ä¸­ props çš„ä¸€éƒ¨åˆ†ã€‚åœ¨ React å…ƒç´ ä¸­è¿˜æœ‰å…¶ä»–çš„ä¸€äº›å­—æ®µæ¯”å¦‚ **ref** ï¼Œä½†é‚£å·²ç»è¶…å‡ºæœ¬æ–‡æ‰€è¦ä»‹ç»çš„å†…å®¹äº†ã€‚

**`ClickCounter`** çš„ React å…ƒç´ ä¸Šå¹¶æ²¡æœ‰ props æˆ–è€… key ï¼š

```js
{
    $$typeof: Symbol(react.element),
    key: null,
    props: {},
    ref: null,
    type: ClickCounter
}
```

### Fiber èŠ‚ç‚¹

åœ¨**åè°ƒ**æœŸé—´ï¼Œä» `render` æ–¹æ³•ä¸­è¿”å›çš„æ¯ä¸ª React å…ƒç´ éƒ½ä¼šè¢«åˆå¹¶åˆ° fiber èŠ‚ç‚¹æ ‘ä¸­å»ã€‚æ¯ä¸€ä¸ª React å…ƒç´ éƒ½æœ‰å…¶å¯¹åº”çš„ fiber èŠ‚ç‚¹ã€‚ä¸ React å…ƒç´ ä¸åŒçš„æ˜¯ï¼Œfibers å¹¶ä¸ä¼šåœ¨æ¯æ¬¡è°ƒç”¨ `render` æ–¹æ³•åè¢«é‡æ–°åˆ›å»ºã€‚å®ƒä»¬æ˜¯æŒæœ‰ç»„ä»¶çŠ¶æ€å’Œ DOM èŠ‚ç‚¹çš„å¯å˜æ•°æ®ç»“æ„ã€‚

æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ React ä¼šæ ¹æ® React å…ƒç´ ç±»å‹çš„ä¸åŒæ¥è¿›è¡Œä¸åŒçš„æ´»åŠ¨ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ä¸­ï¼Œä½œä¸º class ç»„ä»¶çš„ **`ClickCounter`** ä¼šè°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥åŠ `render` æ–¹æ³•ï¼Œè€Œåƒ **`span`** è¿™æ ·çš„ host ç»„ä»¶ï¼ˆDOM èŠ‚ç‚¹ï¼‰å°†ä¼šè¿›è¡Œ DOM çš„æ”¹å˜ã€‚å› æ­¤æ¯ä¸ª React å…ƒç´ éƒ½ä¼šè½¬æ¢æˆç›¸åº”ç±»å‹çš„ Fiber èŠ‚ç‚¹ï¼Œå®ƒä»¬ç”¨æ¥æè¿°éœ€è¦è¢«å®Œæˆçš„å·¥ä½œã€‚

**ä½ å¯ä»¥å°† fiber æƒ³è±¡ä¸ºæœ‰æŸäº›å·¥ä½œè¦åšçš„æ•°æ®ç»“æ„ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªå·¥ä½œå•ä½ã€‚Fiber æ¶æ„åŒæ—¶ä¹Ÿä¸ºæˆ‘ä»¬è·Ÿè¸ªã€è°ƒåº¦ã€æš‚åœå’Œä¸­æ­¢å·¥ä½œæä¾›äº†ä¾¿åˆ©ã€‚**

å½“ React å…ƒç´ ç¬¬ä¸€æ¬¡è¢«è½¬æ¢ä¸º fiber èŠ‚ç‚¹ï¼ŒReact é€šè¿‡ [createFiberFromTypeAndProps](https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js#L414) å‡½æ•°å°†å…ƒç´ ä¸­çš„æ•°æ®ç”¨æ¥åˆ›å»º fiber èŠ‚ç‚¹ã€‚åœ¨åç»­çš„æ›´æ–°ä¸­ React ä¼šé‡ç”¨ fiber èŠ‚ç‚¹å¹¶ä½¿ç”¨æ¥è‡ªç›¸åº” React å…ƒç´ çš„æ•°æ®æ¥æ›´æ–°å¿…è¦çš„å±æ€§ã€‚

React ä¹Ÿå¯èƒ½æ ¹æ® `key` prop ç§»åŠ¨å±‚æ¬¡ç»“æ„ä¸­çš„èŠ‚ç‚¹ï¼Œæˆ–è€…åˆ é™¤æŸäº› fiber èŠ‚ç‚¹å¦‚æœç›¸åº”çš„ React å…ƒç´ ä¸å†ä» `render` æ–¹æ³•ä¸­è¿”å›çš„è¯ã€‚

> æƒ³è¦äº†è§£ç°æœ‰ fiber èŠ‚ç‚¹ä¸­æ‰€æ‰§è¡Œçš„æ‰€æœ‰æ´»åŠ¨åˆ—è¡¨å’Œç›¸åº”çš„å‡½æ•°ï¼Œå¯ä»¥æŸ¥çœ‹ [**ChildReconciler**](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactChildFiber.js#L239) å‡½æ•°ã€‚

å› ä¸º React ä¼šä¸ºæ¯ä¸ª React å…ƒç´ åˆ›å»ºç›¸åº”çš„ fiber èŠ‚ç‚¹ï¼Œæ—¢ç„¶æˆ‘ä»¬æœ‰ React å…ƒç´ æ ‘ï¼Œé‚£æˆ‘ä»¬ä¹Ÿä¼šæœ‰å¯¹åº”çš„ fiber èŠ‚ç‚¹æ ‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ä¼šåƒä¸‹é¢è¿™æ ·å±•ç¤ºå…¶ fiber ç»“æ„ï¼š

![sample](./assets/sample.png)

æ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½é€šè¿‡é“¾è¡¨è¿æ¥ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½ä¼šæœ‰ **`child`** ã€**`sibling`** å’Œ **`return`** å±æ€§ã€‚å¦‚æœæƒ³è¦ç†è§£ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Œä½ å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç«  [React æ˜¯æ€æ ·å’Œä¸ºä»€ä¹ˆè¦åœ¨ Fiber ä¸­ä½¿ç”¨é“¾è¡¨](https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7) ã€‚

### current æ ‘ ä¸ work in progress æ ‘

åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ç»“æŸåï¼ŒReact ä¼šç”Ÿæˆä¸€æ£µå°†åº”ç”¨ä¸­çš„ state æ˜ å°„åˆ° UI ä¸Šçš„ fiber èŠ‚ç‚¹æ ‘ã€‚è€Œè¿™æ£µæ ‘é€šå¸¸è¢«ç§°ä½œ **current** æ ‘ã€‚å½“ React å¼€å§‹æ‰§è¡Œæ›´æ–°æ¸²æŸ“æ—¶ä¼šåˆ›å»ºä¸€æ£µç”¨äºå°†æœªæ¥çš„ state æ˜ å°„åˆ°å±å¹•ä¸Šçš„ **workInProgress** æ ‘ã€‚

æ‰€æœ‰åœ¨ fibers ä¸Šè¿›è¡Œçš„å·¥ä½œéƒ½ä¼šåœ¨ **`workInProgress`** æ ‘ä¸­æ‰§è¡Œã€‚å½“ React éå† **`current`** æ ‘æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªå­˜åœ¨çš„èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ„æˆ **`workInProgress`** æ ‘çš„å¤‡ç”¨èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹æ˜¯é€šè¿‡ `render` æ–¹æ³•è¿”å›çš„ React å…ƒç´ æ•°æ®åˆ›å»ºçš„ã€‚

å½“æ›´æ–°å’Œç›¸åº”çš„å·¥ä½œæ‰§è¡Œå®Œæ¯•åï¼ŒReact å°±ä¼šæ‹¥æœ‰ä¸€æ£µå¤‡ç”¨æ ‘ä¸”éšæ—¶å‡†å¤‡æ˜ å°„åˆ°å±å¹•ä¸Šã€‚ä¸€æ—¦ **`workInProgress`** æ ‘åœ¨å±å¹•ä¸Šè¢«æ¸²æŸ“ï¼Œå®ƒä¹Ÿå°±å˜æˆäº† **`current`** æ ‘ã€‚

React çš„æ ¸å¿ƒåŸåˆ™ä¹‹ä¸€æ˜¯ä¸€è‡´æ€§ã€‚React æ€»æ˜¯ä¸€æ¬¡æ›´æ–° DOM â€Šâ€” å®ƒä¸ä¼šæ˜¾ç¤ºéƒ¨åˆ†çš„ç»“æœã€‚**`workInProgress`** æ ‘å°±åƒè‰ç¨¿ä¸€æ ·ï¼Œå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ React å¯ä»¥å…ˆå¤„ç†å®Œæ‰€æœ‰ç»„ä»¶ï¼Œç„¶åå†å°†æ›´æ–°ä¸€æ¬¡æ€§æ˜ å°„åˆ°å±å¹•ä¸Šã€‚

åœ¨æºç ä¸­ä½ å¯ä»¥çœ‹è§è®¸å¤šå‡½æ•°éƒ½éœ€è¦ä» **`current`** å’Œ **`workInProgress`** æ ‘ä¸­è·å– fiber èŠ‚ç‚¹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼š

```js
function updateHostComponent(current, workInProgress, renderExpirationTime) {...}
```

æ¯ä¸ª fiber èŠ‚ç‚¹åœ¨ **alternate** å­—æ®µä¸­éƒ½ä¿ç•™ç€å¯¹åº”çš„å¦ä¸€æ£µæ ‘ä¸ŠèŠ‚ç‚¹çš„å¼•ç”¨ã€‚ä¾‹å¦‚ **`current`** æ ‘ä¸Šçš„èŠ‚ç‚¹æŒ‡å‘ **`workInProgress`** æ ‘ä¸­å¯¹åº”çš„èŠ‚ç‚¹ï¼Œåä¹‹äº¦ç„¶ã€‚

### å‰¯ä½œç”¨

æˆ‘ä»¬å¯ä»¥æŠŠ React ç»„ä»¶æƒ³è±¡æˆä¸€ä¸ªç”¨ state å’Œ props æ¥è®¡ç®—æœ€ç»ˆ UI æ˜¯å¦‚ä½•å±•ç¤ºçš„å‡½æ•°ã€‚æ¯ä¸ªåƒæ“ä½œ DOM èŠ‚ç‚¹æˆ–è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„æ´»åŠ¨éƒ½åº”è¯¥è¢«ç§°ä½œå‰¯ä½œç”¨åˆæˆ–æ˜¯ä¸€æ¬¡å½±å“ã€‚[å‰¯ä½œç”¨](https://reactjs.org/docs/hooks-overview.html#%EF%B8%8F-effect-hook)åœ¨ React æ–‡æ¡£ä¸­ä¹Ÿè¢«æåˆ°è¿‡ã€‚

> åœ¨ä»¥å‰ï¼Œä½ å¯èƒ½ä¼šåœ¨ React ç»„ä»¶ä¸­è¿›è¡Œåƒæ•°æ®è·å–ã€è®¢é˜…æ•°æ®æºæˆ–è€…æ‰‹åŠ¨æ“ä½œ DOM ç­‰æ´»åŠ¨ã€‚æˆ‘ä»¬æŠŠè¿™äº›æ“ä½œç§°ä¸º â€œå‰¯ä½œç”¨â€ å› ä¸ºå®ƒä»¬ä¼šå½±å“å…¶ä»–çš„ç»„ä»¶å¹¶ä¸”åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ— æ³•å®Œæˆã€‚

å¦‚ä½ æ‰€è§ï¼Œå¤§å¤šæ•°çš„ state å’Œ props æ›´æ–°éƒ½å°†å¯¼è‡´ â€œå‰¯ä½œç”¨â€ çš„å‘ç”Ÿã€‚æ—¢ç„¶æ‰§è¡Œå‰¯ä½œç”¨æ˜¯ä¸€ç§ç±»å‹çš„å·¥ä½œï¼Œé‚£ fiber èŠ‚ç‚¹é™¤äº†ç”¨äºæ›´æ–°å¤–ï¼Œå®ƒä¹Ÿå¯ä»¥ä½œä¸ºè·Ÿè¸ª effects çš„ä¾¿åˆ©æœºåˆ¶ã€‚æ¯ä¸ª fiber èŠ‚ç‚¹éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ effects ã€‚å®ƒä»¬åœ¨ **`effectTag`** å­—æ®µä¸­è¢«ç¼–ç ã€‚

å› æ­¤ effects ä»£è¡¨ç€åœ¨å¤„ç†æ›´æ–°åéœ€è¦ä¸ºå®ä¾‹å®Œæˆçš„[å·¥ä½œ](https://github.com/facebook/react/blob/b87aabdfe1b7461e7331abb3601d9e6bb27544bc/packages/shared/ReactSideEffectTags.js) ã€‚å¯¹äº host ç»„ä»¶ï¼ˆDOM èŠ‚ç‚¹ï¼‰æ¥è¯´å¯èƒ½åŒ…å«å¢åŠ ã€æ›´æ–°å’Œåˆ é™¤å…ƒç´ çš„å·¥ä½œã€‚è€Œå¯¹äº class ç»„ä»¶ React å¯èƒ½ä¼šæ›´æ–° refs ä»¥åŠè°ƒç”¨åƒ `componentDidMount` å’Œ `componentDidUpdate` è¿™æ ·çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„ effects å¯¹åº”ç€å…¶ä»–ç±»å‹çš„ fiber ã€‚

### Effects åˆ—è¡¨

React èƒ½å¤Ÿéå¸¸å¿«é€Ÿåœ°è¿›è¡Œæ¸²æŸ“æ›´æ–°ï¼Œä¸ºäº†è¾¾åˆ°è¿™æ ·çš„é«˜æ€§èƒ½æ°´å¹³ï¼Œå®ƒé‡‡ç”¨äº†ä¸€äº›æœ‰è¶£çš„æŠ€æœ¯ã€‚**å…¶ä¸­ä¹‹ä¸€å°±æ˜¯ç”¨çº¿æ€§è¡¨æ„å»ºå¸¦æœ‰ effects çš„ fiber èŠ‚ç‚¹ï¼Œè¿™æ ·å°±æ‹¥æœ‰äº†å¿«é€Ÿè¿­ä»£çš„æ•ˆæœã€‚** è¿­ä»£çº¿æ€§è¡¨è¿œæ¯”è¿­ä»£æ ‘è¦æ¥çš„å¿«ï¼Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦åœ¨ä¸å«å‰¯ä½œç”¨çš„èŠ‚ç‚¹ä¸Šæµªè´¹æ—¶é—´ã€‚

è¯¥åˆ—è¡¨çš„ç›®æ ‡æ˜¯æ ‡è®°å…·æœ‰ DOM æ›´æ–°æˆ–è€…ä¸ effects ç›¸å…³çš„èŠ‚ç‚¹ã€‚è¯¥åˆ—è¡¨æ˜¯ **`finishedWork`** æ ‘çš„å­é›†ï¼Œä½¿ç”¨ **`nextEffects`** å±æ€§è€Œä¸æ˜¯ **`current`** å’Œ **`workInProgress`** æ ‘ä¸­çš„ **`child`** å±æ€§è¿›è¡Œè¿æ¥ã€‚

[Dan Abramov](https://medium.com/@dan_abramov) ä¸º effects åˆ—è¡¨ç»™å‡ºäº†ä¸€ä¸ªç±»æ¯”ã€‚ä»–å–œæ¬¢å°†å…¶æ¯”ä½œåœ£è¯æ ‘ï¼Œæ‰€æœ‰çš„ effects èŠ‚ç‚¹éƒ½ä¼šè¢« â€œåœ£è¯ç¯â€ ç»‘å®šåœ¨ä¸€èµ·ã€‚ä¸ºäº†å°†å…¶å¯è§†åŒ–ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹åœ¨å«æœ‰ fiber èŠ‚ç‚¹çš„æ ‘ä¸­ï¼Œé‚£äº›é«˜äº®ç€çš„èŠ‚ç‚¹å°±ä»£è¡¨ç€éœ€è¦è¢«å®Œæˆçš„å·¥ä½œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„æ›´æ–°å¯¼è‡´ **`c2`** è¢«æ’å…¥ DOM ä¸­ï¼Œ**`d2`** å’Œ **`c1`** ä¼šæ”¹å˜å…¶è‡ªèº«çš„å±æ€§ï¼Œè€Œ **`b2`** åˆ™è¦è°ƒç”¨æŸä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚effects åˆ—è¡¨ä¼šå°†å®ƒä»¬è¿æ¥èµ·æ¥ï¼Œä¾¿äº React åœ¨ä¹‹åç›´æ¥è·³è¿‡å…¶ä»–èŠ‚ç‚¹ï¼š

![linear](./assets/linear.png)

ç°åœ¨ä½ åº”è¯¥æ˜ç™½å…·æœ‰ effects çš„èŠ‚ç‚¹æ˜¯å¦‚ä½•è¿æ¥åœ¨ä¸€èµ·çš„äº†ã€‚å½“æˆ‘ä»¬éå†èŠ‚ç‚¹æ—¶ï¼ŒReact ç”¨ **`firstEffect`** æŒ‡é’ˆæ¥æ‰¾åˆ°åˆ—è¡¨çš„å¼€å¤´ã€‚å› æ­¤ä¸Šå›¾ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºè¿™æ ·çš„çº¿æ€§è¡¨ï¼š

![list](./assets/list.png)

å¦‚ä½ æ‰€è§ï¼ŒReact ä¼šæŒ‰ç…§ä»å­ä»£åˆ°åŒäº²çš„é¡ºåºä¾æ¬¡è°ƒç”¨ effectsã€‚

### Fiber æ ‘çš„å¤´èŠ‚ç‚¹

æ¯ä¸€ä¸ª React åº”ç”¨éƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª DOM å…ƒç´ ä½œä¸ºå®¹å™¨ã€‚åœ¨æœ¬ä¾‹ä¸­æŒ‡çš„æ˜¯ ID ä¸º **`container`** çš„ **`div`** å…ƒç´ ã€‚

```js
const domContainer = document.querySelector('#container')
ReactDOM.render(React.createElement(ClickCounter), domContainer)
```

React ä¼šä¸ºæ¯ä¸€ä¸ªä½œä¸ºå®¹å™¨çš„å…ƒç´ åˆ›å»ºä¸€ä¸ª [fiber root](https://github.com/facebook/react/blob/0dc0ddc1ef5f90fe48b58f1a1ba753757961fc74/packages/react-reconciler/src/ReactFiberRoot.js#L31) å¯¹è±¡ï¼Œä½ å¯ä»¥é€šè¿‡å¯¹ DOM å…ƒç´ çš„å¼•ç”¨æ¥è®¿é—®å®ƒã€‚

```js
const fiberRoot = query('#container')._reactRootContainer._internalRoot
```

fiber root ä¿ç•™ç€å¯¹ fiber æ ‘çš„å¼•ç”¨ã€‚å®ƒè¢«å‚¨å­˜åœ¨ fiber root çš„ **`current`** å±æ€§ä¸Šï¼š 

```js
const hostRootFiberNode = fiberRoot.current
```

fiber æ ‘çš„å¤´èŠ‚ç‚¹æ˜¯ä¸€ç§[ç‰¹æ®Šç±»å‹](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/shared/ReactWorkTags.js#L34)çš„ fiber èŠ‚ç‚¹ï¼Œå®ƒè¢«ç§°ä½œ **`HostRoot`** ã€‚å®ƒåœ¨å†…éƒ¨è¢«åˆ›å»ºï¼Œå¹¶å……å½“äº†æœ€é¡¶å±‚ç»„ä»¶çš„çˆ¶çº§ã€‚**`HostRoot`** fiber èŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ª **`stateNode`** å±æ€§ç”¨äºè¿”å›åˆ° **`FiberRoot`** ï¼š

```js
fiberRoot.current.stateNode === fiberRoot; // true
```

ä½ å¯ä»¥é€šè¿‡ fiber root æ¥è®¿é—®æœ€é¡¶å±‚çš„ **`HostRoot`** fiber èŠ‚ç‚¹ï¼Œç„¶åå†è¿›ä¸€æ­¥åœ°æ·±å…¥ fiber æ ‘ã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä»ç»„ä»¶å®ä¾‹ä¸Šè·å–ç‹¬ç«‹çš„ fiber èŠ‚ç‚¹å°±åƒä¸‹é¢è¿™æ ·ï¼š

```js
compInstance._reactInternalFiber
```

### Fiber èŠ‚ç‚¹çš„ç»“æ„

è®©æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸º **`ClickCounter`** ç»„ä»¶åˆ›å»ºçš„ fiber èŠ‚ç‚¹çš„ç»“æ„ï¼š

```js
{
    stateNode: new ClickCounter,
    type: ClickCounter,
    alternate: null,
    key: null,
    updateQueue: null,
    memoizedState: {count: 0},
    pendingProps: {},
    memoizedProps: {},
    tag: 1,
    effectTag: 0,
    nextEffect: null
}
```

è¿™æ˜¯ **`span`** DOM å…ƒç´ çš„ fiber ç»“æ„ï¼š

```js
{
    stateNode: new HTMLSpanElement,
    type: "span",
    alternate: null,
    key: "2",
    updateQueue: null,
    memoizedState: null,
    pendingProps: {children: 0},
    memoizedProps: {children: 0},
    tag: 5,
    effectTag: 0,
    nextEffect: null
}
```

fiber èŠ‚ç‚¹ä¸Šæœ‰å¾ˆå¤šçš„å­—æ®µã€‚åœ¨ä¹‹å‰æˆ‘å·²ç»ä»‹ç»è¿‡ **`alternate`** ã€**`effectTag`** å’Œ **`nextEffect`** å­—æ®µçš„ä½œç”¨ã€‚ä¸‹é¢è®©æˆ‘ä»¬å¼€å§‹ç†è§£ä¸ºä»€ä¹ˆè¿˜éœ€è¦å…¶ä»–çš„å­—æ®µå§ã€‚

#### stateNode

æŒæœ‰å¯¹ç»„ä»¶çš„ç±»å®ä¾‹ã€DOM èŠ‚ç‚¹æˆ–è€…å…¶ä»–ä¸ fiber èŠ‚ç‚¹ç›¸å…³çš„ React å…ƒç´ ç±»å‹ã€‚ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬å¯ä»¥è¯´è¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥ä¿å­˜ä¸ fiber ç›¸å…³çš„å±€éƒ¨çŠ¶æ€ã€‚

#### type

å®šä¹‰ fiber æ˜¯å‡½æ•°è¿˜æ˜¯ç±»ã€‚å¯¹äº class ç»„ä»¶æ¥è®²ï¼Œå®ƒæŒ‡å‘ constructor å‡½æ•°è€Œå¯¹äº DOM å…ƒç´ æ¥è®²å®ƒç”¨æ¥æè¿°ä¸€ä¸ª HTML æ ‡ç­¾ã€‚æˆ‘ç»å¸¸ç”¨è¿™ä¸ªå­—æ®µæ¥ç†è§£ fiber èŠ‚ç‚¹åˆ°åº•ä¸å“ªä¸ª React å…ƒç´ ç›¸å…³è”ã€‚

#### tag

å®šä¹‰ [fiber çš„ç±»å‹](https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/shared/ReactWorkTags.js)ã€‚å®ƒåœ¨åè°ƒç®—æ³•ä¸­ç”¨äºç¡®å®šé‚£äº›éœ€è¦å®Œæˆçš„ work ã€‚å°±åƒä¹‹å‰æåˆ°è¿‡çš„ï¼Œè¿™äº› work ä¼šå› ä¸º React å…ƒç´ ç±»å‹çš„ä¸åŒè€Œä¸åŒã€‚[createFiberFromTypeAndProps](https://github.com/facebook/react/blob/769b1f270e1251d9dbdce0fcbd9e92e502d059b8/packages/react-reconciler/src/ReactFiber.js#L414) å‡½æ•°ä¼šå°† React å…ƒç´ æ˜ å°„åˆ°ç›¸åº”çš„ fiber èŠ‚ç‚¹ç±»å‹ä¸Šã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œ**`ClickCounter`** ç»„ä»¶çš„ **`tag`** æ˜¯ **`1`** ä»£è¡¨ç€ **`ClassComponent`** ï¼Œè€Œ **`span`** å…ƒç´ ä¸º **`5`** ä»£è¡¨ç€ **`HostComponent`** ã€‚

#### updateQueue

ç”¨äº state æ›´æ–°ã€å›è°ƒå’Œ DOM æ›´æ–°çš„é˜Ÿåˆ—ã€‚

#### memoizedState

ç”¨æ¥åˆ›å»ºè¾“å‡ºçš„ fiber èŠ‚ç‚¹ä¸Šçš„ state ã€‚åœ¨å¤„ç†æ›´æ–°æ—¶ï¼Œå®ƒåæ˜ ç€å°†ä¼šåœ¨å½“å‰å±å¹•ä¸Šæ¸²æŸ“çš„ state ã€‚

#### memoizedProps

åœ¨å‰ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­ç”¨æ¥åˆ›å»ºè¾“å‡ºçš„ fiber èŠ‚ç‚¹ä¸Šçš„ props ã€‚

#### pendingProps

ä» React å…ƒç´ çš„æ–°æ•°æ®ä¸­æ›´æ–°çš„ props ï¼Œç­‰å¾…ç€åœ¨å…¶å­ç»„ä»¶å’Œ DOM å…ƒç´ ä¸­è¢«ä½¿ç”¨ã€‚

#### key

ä¸€ç»„å­ä»£ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œèƒ½å¤Ÿå¸®åŠ© React ç¡®å®šåˆ—è¡¨ä¸­å“ªäº›èŠ‚ç‚¹å‘ç”Ÿäº†æ”¹å˜ã€å¢åŠ æˆ–åˆ é™¤ã€‚

ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/facebook/react/blob/6e4f7c788603dac7fccd227a4852c110b072fe16/packages/react-reconciler/src/ReactFiber.js#L78)æ‰¾åˆ°å®Œæ•´çš„ fiber èŠ‚ç‚¹ç»“æ„ã€‚æˆ‘åœ¨ä¸Šé¢çš„è§£é‡Šä¸­çœç•¥äº†ä¸€äº›å­—æ®µã€‚ç‰¹åˆ«çš„ï¼Œæˆ‘è·³è¿‡äº† **`child`** ã€**`sibling`** å’Œ **`return`** è¿™äº›æŒ‡é’ˆï¼Œå®ƒä»¬æ„æˆäº†[ä¸Šç¯‡æ–‡ç« ](https://medium.com/react-in-depth/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-67f1014d0eb7)ä¸­æˆ‘æ‰€æè¿°çš„ä¸€ç§æ ‘æ•°æ®ç»“æ„ã€‚è¿˜æœ‰åƒ **`expirationTime`** ã€**`childExpirationTime`** å’Œ **`mode`** è¿™äº›ä¸ **`Scheduler`** ç‰¹å®šç±»åˆ«ç›¸å…³çš„å­—æ®µã€‚

## é€šç”¨ç®—æ³•

React ä¸»è¦åœ¨ä¸¤ä¸ªé˜¶æ®µæ‰§è¡Œç›¸åº”çš„ work ï¼š**render** é˜¶æ®µå’Œ **commit** é˜¶æ®µã€‚

åœ¨ç¬¬ä¸€æ¬¡ **render** é˜¶æ®µæ‰§è¡ŒæœŸé—´ï¼ŒReact ä¼šå°†æ›´æ–°åº”ç”¨äºé‚£äº›é€šè¿‡ **`setState`** æˆ–è€… **`React.render`** è°ƒåº¦çš„ç»„ä»¶ï¼Œå¹¶ä¸”åˆ¤æ–­å‡ºéœ€è¦åœ¨ UI ä¸­æ›´æ–°çš„å†…å®¹ã€‚å¦‚æœæ˜¯åˆæ¬¡æ¸²æŸ“ï¼ŒReact ä¼šä¸ºä» **`render`** æ–¹æ³•ä¸­è¿”å›çš„æ¯ä¸€ä¸ªå…ƒç´ åˆ›å»ºä¸€ä¸ªæ–°çš„ fiber èŠ‚ç‚¹ã€‚åœ¨åç»­çš„æ›´æ–°ä¸­ï¼Œå·²æœ‰çš„ React å…ƒç´ å¯¹åº”çš„ fiber èŠ‚ç‚¹ä¼šè¢«é‡ç”¨å’Œæ›´æ–°ã€‚**è¿™ä¸ªé˜¶æ®µæœ€ç»ˆçš„æ‰§è¡Œç»“æœå°±æ˜¯ç”Ÿæˆä¸€æ£µå¸¦æœ‰å‰¯ä½œç”¨çš„ fiber èŠ‚ç‚¹æ ‘ã€‚** è¿™äº› effects æè¿°äº†åœ¨ **`commit`** é˜¶æ®µå°†ä¼šè¢«æ‰§è¡Œçš„ work ã€‚åœ¨ **`commit`** é˜¶æ®µï¼ŒReact ä¼šå°†å¸¦æœ‰å‰¯ä½œç”¨çš„ fiber èŠ‚ç‚¹æ ‘ä½œç”¨åˆ°å®ä¾‹ä¸Šã€‚å®ƒä¼šéå†æ•´ä¸ª effects åˆ—è¡¨ç„¶åæ‰§è¡Œåƒ DOM æ›´æ–°å’Œå…¶ä»–å¯¹ç”¨æˆ·å¯è§çš„æ“ä½œã€‚

**ç†è§£åœ¨ `render` é˜¶æ®µæ‰§è¡Œçš„å·¥ä½œå¯ä»¥æ˜¯å¼‚æ­¥çš„ååˆ†é‡è¦ã€‚** React èƒ½å¤Ÿæ ¹æ®å¯ç”¨æ—¶é—´åŒæ—¶å¤„ç†ä¸€ä¸ªæˆ–è€…å¤šä¸ª fiber èŠ‚ç‚¹ï¼Œå¦‚æœå‘ç°æœ¬è½®çš„å¯ç”¨æ—¶é—´è€—å°½ï¼ŒReact å°±ä¼šå…ˆåœæ­¢ä¸‹æ¥æŠŠé‚£äº›å·²ç»å®Œæˆçš„ work å­˜å¥½ç„¶åæš‚åœæŸäº›äº‹ä»¶ã€‚å½“åˆæœ‰å¯ç”¨æ—¶é—´çš„æ—¶å€™æ‰ä¼šä»åŸå…ˆåœæ­¢çš„åœ°æ–¹ç»§ç»­ã€‚è™½ç„¶åœ¨æœ‰äº›æ—¶å€™ React ä¸å¾—ä¸ä¸¢å¼ƒå·²ç»å®Œæˆçš„ work ç„¶åå†ä»å¤´å¼€å§‹ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥åœ¨ **`render`** é˜¶æ®µèƒ½å¤Ÿæš‚åœé‚£äº›æ­£åœ¨æ‰§è¡Œçš„ work æ˜¯å› ä¸ºè¿™äº› work å¹¶ä¸ä¼šé€ æˆç”¨æˆ·å¯è§çš„æ”¹å˜ï¼Œä¾‹å¦‚ DOM çš„æ›´æ–°ã€‚**ç›¸åï¼Œæ¥ä¸‹æ¥çš„ `commit` é˜¶æ®µæ€»æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚** å› ä¸ºåœ¨è¿™ä¸ªé˜¶æ®µçš„æ“ä½œä¼šç›´æ¥é€ æˆå¯¹ç”¨æˆ·å¯è§çš„æ”¹å˜ï¼Œæ¯”å¦‚è¯´ DOM çš„æ›´æ–°ã€‚è¿™ä¹Ÿæ­£æ˜¯ React éœ€è¦ä¸€æ¬¡å°±å®Œæˆå®ƒä»¬çš„åŸå› ã€‚

è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ˜¯ React æ‰§è¡Œ work çš„ç±»å‹ä¹‹ä¸€ã€‚æœ‰äº›æ–¹æ³•åœ¨ **`render`** é˜¶æ®µè¢«è°ƒç”¨ï¼Œè€Œå¦å¤–ä¸€äº›æ–¹æ³•åˆ™ä¼šåœ¨ **`commit`** é˜¶æ®µè¢«è°ƒç”¨ã€‚ä¸‹é¢æ˜¯åœ¨ **`render`** é˜¶æ®µä¼šè¢«è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•åˆ—è¡¨ï¼š

- [UNSAFE_] componentWillMount (å¼ƒç”¨)
- [UNSAFE_] componentWillReceiveProps (å¼ƒç”¨)
- getDerivedStateFromProps
- shouldComponentUpdate
- [UNSAFE_] componentWillUpdate (å¼ƒç”¨)
- render 

å¦‚ä½ æ‰€è§ï¼Œåœ¨ **`render`** é˜¶æ®µæ‰§è¡Œçš„ä¸€äº›é—ç•™çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä» React 16.3 ç‰ˆæœ¬å¼€å§‹å°±å·²ç»è¢«æ ‡è®°ä¸º **`UNSAFE`** ã€‚è¿™äº›é—ç•™çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°†ä¼šåœ¨ React 16.x ç‰ˆæœ¬ä¸­è¢«å¼ƒç”¨ï¼Œè€Œä¸ä¹‹åŒåä½†æ²¡æœ‰è¢«æ ‡è®°çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°†ä¼šåœ¨ 17.0 ç‰ˆæœ¬ä¸­è¢«ç§»é™¤ã€‚

ä½ ä¼šå¯¹ React å›¢é˜Ÿåšå‡ºè¿™æ ·çš„æ”¹å˜è€Œæ„Ÿåˆ°å¥½å¥‡å—ï¼Ÿ

å¥½å§ï¼Œæˆ‘ä»¬åˆšåˆšæ‰äº†è§£åˆ°åœ¨ **`render`** é˜¶æ®µå¹¶ä¸ä¼šè¿›è¡Œåƒ DOM æ›´æ–°é‚£æ ·çš„å‰¯ä½œç”¨æ“ä½œï¼Œå› æ­¤ React å°±æœ‰äº†å¤„ç†å¼‚æ­¥æ›´æ–°ä¸å¼‚æ­¥ç»„ä»¶çš„èƒ½åŠ›ï¼ˆç”šè‡³èƒ½å¤Ÿä»¥å¤šçº¿ç¨‹çš„æ–¹å¼è¿›è¡Œæ­¤æ“ä½œï¼‰ã€‚ç„¶è€Œï¼Œé‚£äº›æ ‡æœ‰ **`UNSAFE`** çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç»å¸¸ä¼šè¢«è¯¯è§£å’Œè¯¯ç”¨ã€‚å¼€å‘è€…ä¼šæŠŠå¸¦æœ‰å‰¯ä½œç”¨çš„ä»£ç æ”¾å…¥è¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­ï¼Œè€Œåœ¨æ–°çš„å¼‚æ­¥æ¸²æŸ“æœºåˆ¶é‡Œè¿™æ ·åšå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚è™½ç„¶é‚£äº›åŒåä½†æ²¡æœ‰è¢«æ ‡è®°ä¸º **`UNSAFE`** çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å°†ä¼šåœ¨æœªæ¥è¢«ç§»é™¤ï¼Œä½†åœ¨å³å°†æ¥ä¸´çš„å¹¶å‘æ¨¡å¼ä¸‹çš„ React ä¸­ä½¿ç”¨è¿™äº› **`UNSAFE`** æ ‡è®°çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»ä¼šæœ‰å¾ˆå¤§å‡ ç‡å‡ºç° bug ã€‚

ä¸‹é¢æ˜¯åœ¨ **`commit`** é˜¶æ®µä¼šæ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•åˆ—è¡¨ï¼š

- getSnapshotBeforeUpdate
- componentDidMount
- componentDidUpdate
- componentWillUnmount

å› ä¸ºè¿™äº›æ–¹æ³•åœ¨åŒæ­¥çš„ **`commit`** é˜¶æ®µè¢«æ‰§è¡Œï¼Œå› è€Œå®ƒä»¬ä¸­å¯èƒ½å¸¦æœ‰å‰¯ä½œç”¨å¹¶ä¸”ä¹Ÿå¯èƒ½è¿›è¡Œ DOM çš„æ“ä½œã€‚

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†å¿…è¦çš„å‰ç½®çŸ¥è¯†ï¼Œè¿™è¶³ä»¥è®©æˆ‘ä»¬æ·±å…¥ç”¨äºéå†æ ‘å’Œæ‰§è¡Œ work çš„é€šç”¨ç®—æ³•ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

### Render é˜¶æ®µ

åè°ƒç®—æ³•æ€»æ˜¯ä½¿ç”¨ [renderRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1132) å‡½æ•°ä»æœ€é¡¶å±‚çš„ **`HostRoot`** fiber èŠ‚ç‚¹å¼€å§‹ã€‚ä½†æ˜¯ï¼ŒReact ä¼šè·³è¿‡é‚£äº›å·²ç»å¤„ç†è¿‡çš„ fiber èŠ‚ç‚¹ç›´åˆ°å‘ç°å¸¦æœ‰æœªå®Œæˆçš„ work çš„ fiber èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨ç»„ä»¶æ ‘çš„æ·±å¤„è°ƒç”¨ **`setState`** ï¼ŒReact ä¼šä»æœ€é¡¶å±‚å¼€å§‹ä½†å®ƒä¼šå¾ˆå¿«åœ°è·³è¿‡é‚£äº›çˆ¶ç»„ä»¶ç›´åˆ°å‘ç°è°ƒç”¨ **`setState`** æ–¹æ³•çš„ç»„ä»¶ã€‚

#### work loop çš„ä¸»è¦æ­¥éª¤

æ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½ä¼šåœ¨ [work loop](https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136) ä¸­è¢«å¤„ç†ã€‚ä¸‹é¢æ˜¯è¯¥ loop ä¸­åŒæ­¥æ‰§è¡Œéƒ¨åˆ†çš„å®ç°ä»£ç ï¼š

```js
function workLoop(isYieldy) {
  if (!isYieldy) {
    while (nextUnitOfWork !== null) {
      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    }
  } else {...}
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ**`nextUnitOfWork`** æŒæœ‰æ¥è‡ª **`workInProgress`** æ ‘ä¸­é‚£äº›å¸¦æœ‰ work ä¸”éœ€è¦è¢«æ‰§è¡Œçš„ fiber èŠ‚ç‚¹çš„å¼•ç”¨ã€‚å½“ React éå†æ•´ä¸ª Fiber æ ‘æ—¶ï¼Œé€šè¿‡è¿™ä¸ªå˜é‡å°±èƒ½å¤Ÿæ¸…æ¥šåœ°çŸ¥é“å“ªäº› fiber èŠ‚ç‚¹ä¸Šå«æœ‰æœªå®Œæˆçš„ work ã€‚åœ¨å½“å‰çš„ fiber è¢«å¤„ç†å®Œä¹‹åï¼Œè¿™ä¸ªå˜é‡è¦ä¹ˆä¼šæŒæœ‰ä¸‹ä¸€ä¸ªæ ‘ä¸­çš„ fiber èŠ‚ç‚¹çš„å¼•ç”¨è¦ä¹ˆå°±ä¸º **`null`** ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ React ä¾¿ä¼šé€€å‡º work loop ç„¶åéšæ—¶å‡†å¤‡ç€ commit å·²æœ‰çš„æ”¹å˜ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬æœ‰å››ç§ä¸»è¦çš„å‡½æ•°ç”¨äºéå†æ ‘ä»¥åŠå¼€å§‹æˆ–ç»“æŸæŸä¸ª work ï¼š

- [performUnitOfWork](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1056)
- [beginWork](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberBeginWork.js#L1489)
- [completeUnitOfWork](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L879)
- [completeWork](https://github.com/facebook/react/blob/cbbc2b6c4d0d8519145560bd8183ecde55168b12/packages/react-reconciler/src/ReactFiberCompleteWork.js#L532)

ä¸ºäº†å±•ç¤ºå®ƒä»¬æ˜¯å¦‚ä½•è¢«ä½¿ç”¨çš„ï¼Œè¯·çœ‹ä¸‹é¢ç”¨æ¥éå†ä¸€æ£µ fiber æ ‘çš„åŠ¨ç”»ã€‚ä¸ºäº†å±•ç¤ºè¿™ä¸ªä¾‹å­æˆ‘ç»™å‡ºäº†è¿™äº›å‡½æ•°çš„ç®€å•å®ç°ã€‚æ¯ä¸ªå‡½æ•°éƒ½éœ€è¦å¤„ç†ç›¸åº”çš„ fiber èŠ‚ç‚¹ï¼Œå½“ React å¾€ä¸‹éå†æ—¶ï¼Œä½ å¯ä»¥çœ‹åˆ°å½“å‰æ´»åŠ¨çš„ fiber èŠ‚ç‚¹å‘ç”Ÿäº†æ”¹å˜ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢æˆ‘ç»™å‡ºçš„è§†é¢‘é“¾æ¥ä¸­æ¸…æ™°åœ°çœ‹å‡ºè¿™ä¸ªç®—æ³•åœ¨éå†æ ‘æ—¶æ˜¯å¦‚ä½•ä»ä¸€ä¸ªåˆ†æ”¯åˆ‡æ¢åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šå»çš„ã€‚å®ƒé¦–å…ˆä¼šå®Œæˆå­ fiber èŠ‚ç‚¹ä¸­å¸¦æœ‰çš„ work ï¼Œç„¶åæ‰ä¼šç§»åŠ¨åˆ°çˆ¶ fiber èŠ‚ç‚¹ä¸Šã€‚

![works](./assets/works.gif)

> ***è¯·æ³¨æ„ç”±ç›´çº¿å‚ç›´è¿æ¥çš„ fiber èŠ‚ç‚¹å±äºå…„å¼ŸèŠ‚ç‚¹ï¼Œè€Œä»¥å¼¯æ›²æ–¹å¼è¿æ¥çš„èŠ‚ç‚¹æ‰æ˜¯çˆ¶å­èŠ‚ç‚¹çš„å…³ç³»ï¼Œä¾‹å¦‚ `b1` æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œè€Œ `b2` å´æœ‰ä¸€ä¸ªå«åš `c1` çš„å­èŠ‚ç‚¹ã€‚***

[è¿™æ˜¯è§†é¢‘çš„é“¾æ¥](https://vimeo.com/302222454)ï¼Œä½ å¯ä»¥éšæ—¶æš‚åœæ’­æ”¾å¹¶æ£€æŸ¥å½“å‰çš„èŠ‚ç‚¹ä¸å‡½æ•°æ‰§è¡Œçš„çŠ¶æ€ã€‚ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œä½ å¯ä»¥å°† â€œbeginâ€ çœ‹ä½œåˆšè¿›å…¥ç»„ä»¶å¹¶å¼€å§‹ç›¸åº”çš„ work ï¼Œè€Œ â€œcompeteâ€ åˆ™ä»£è¡¨ç€ work æ‰§è¡Œå®Œæ¯•å¯ä»¥é€€å‡ºç»„ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥å…ˆçœ‹çœ‹æˆ‘[ç»™å‡ºçš„å®ç°ä»£ç å’Œç›¸åº”çš„ä¾‹å­](https://stackblitz.com/edit/js-ntqfil?file=index.js)ï¼Œå› ä¸ºé©¬ä¸Šæˆ‘å°†ä¼šè§£é‡Šè¿™äº›å‡½æ•°çš„ä½œç”¨ã€‚

è®©æˆ‘ä»¬å…ˆä»æœ€å¼€å§‹çš„ **`performUnitOfWork`** å’Œ **`beginWork`** å‡½æ•°å¼€å§‹ï¼š

```js
function performUnitOfWork(workInProgress) {
    let next = beginWork(workInProgress);
    if (next === null) {
        next = completeUnitOfWork(workInProgress);
    }
    return next;
}

function beginWork(workInProgress) {
    console.log('work performed for ' + workInProgress.name);
    return workInProgress.child;
}
```

**`performUnitOfWork`** å‡½æ•°æ¥æ”¶æ¥è‡ª **`workInProgress`** æ ‘ä¸­çš„ fiber èŠ‚ç‚¹ï¼Œç„¶åç”¨ **`beginWork`** å‡½æ•°å¼€å§‹ work çš„æ‰§è¡Œã€‚è¿™ä¸ªå‡½æ•°ä¼šå¼€å§‹å½“å‰ fiber ä¸­æ‰€æœ‰éœ€è¦è¢«æ‰§è¡Œçš„æ´»åŠ¨ã€‚å‡ºäºå±•ç¤ºçš„ç›®çš„ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°æ‰“å°äº†å½“å‰ fiber çš„åå­—æ¥è¡¨ç¤ºå·²ç»å®Œæˆçš„ work ã€‚**`beginWork` å‡½æ•°æ€»æ˜¯ä¼šè¿”å›åœ¨ loop ä¸­éœ€è¦è¢«å¤„ç†çš„ä¸‹ä¸€ä¸ªå­ fiber èŠ‚ç‚¹æˆ–è€…æ˜¯ `null` ã€‚** 

å¦‚æœæœ‰ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨ **`workLoop`** å‡½æ•°ä¸­è¢«èµ‹å€¼ç»™ **`nextUnitOfWork`** å˜é‡ã€‚ç„¶è€Œï¼Œè¦æ˜¯æ²¡æœ‰ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹ï¼ŒReact å°±ä¼šå¯Ÿè§‰åˆ°æ­¤æ—¶åˆ°è¾¾äº†åˆ†æ”¯çš„åº•éƒ¨å› æ­¤ä¾¿å¯ä»¥ç»“æŸå½“å‰èŠ‚ç‚¹çš„ work ã€‚**ä¸€æ—¦å½“å‰èŠ‚ç‚¹çš„ work ç»“æŸï¼ŒReact ä¾¿ä¼šå¼€å§‹æ‰§è¡Œå®ƒçš„å…„å¼ŸèŠ‚ç‚¹ä¸Šçš„ workï¼Œç„¶åå†è¿”å›åˆ°çˆ¶èŠ‚ç‚¹ä¸Šã€‚** ä¸‹é¢çš„ä»£ç æ˜¯åœ¨ **`completeUnitOfWork`** å‡½æ•°ä¸­å®Œæˆçš„ï¼š

```js
function completeUnitOfWork(workInProgress) {
    while (true) {
        let returnFiber = workInProgress.return;
        let siblingFiber = workInProgress.sibling;

        nextUnitOfWork = completeWork(workInProgress);

        if (siblingFiber !== null) {
            // If there is a sibling, return it
            // to perform work for this sibling
            return siblingFiber;
        } else if (returnFiber !== null) {
            // If there's no more work in this returnFiber,
            // continue the loop to complete the parent.
            workInProgress = returnFiber;
            continue;
        } else {
            // We've reached the root.
            return null;
        }
    }
}

function completeWork(workInProgress) {
    console.log('work completed for ' + workInProgress.name);
    return null;
}
```

ä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ç”±å¾ˆå¤§çš„ **`while`** å¾ªç¯æ„æˆã€‚å½“ **`workInProgress`** æ ‘ä¸­çš„èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹çš„æ—¶å€™ï¼ŒReact ä¾¿ä¼šæ‰§è¡Œä¸Šé¢è¿™ä¸ªå‡½æ•°ã€‚åœ¨ç»“æŸå½“å‰çš„ fiber èŠ‚ç‚¹åï¼Œä¾¿ä¼šæ£€æŸ¥è¯¥èŠ‚ç‚¹æ˜¯å¦å«æœ‰å…„å¼ŸèŠ‚ç‚¹ã€‚å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ï¼ŒReact ä¾¿ä¼šæå‰è·³å‡ºå¾ªç¯å¹¶è¿”å›è¯¥å…„å¼ŸèŠ‚ç‚¹ã€‚è¿”å›çš„è¿™ä¸ªèŠ‚ç‚¹å°†ä¼šè¢«èµ‹å€¼ç»™ **`nextUnitOfWork`** å˜é‡ï¼Œç„¶å React ä¾¿ä¼šä»è¿™ä¸ªå…„å¼ŸèŠ‚ç‚¹å¼€å§‹çš„åˆ†æ”¯å¾€ä¸‹ç»§ç»­æ‰§è¡Œç›¸åº”çš„ work ã€‚ç†è§£ React åªä¼šå…ˆå®Œæˆå‰é¢å…„å¼ŸèŠ‚ç‚¹çš„ work ååˆ†é‡è¦ï¼Œå®ƒå¹¶ä¸ä¼šæå‰ç»“æŸçˆ¶èŠ‚ç‚¹çš„ work ã€‚**åªæœ‰åœ¨å®Œæˆä»¥å­èŠ‚ç‚¹å¼€å§‹çš„æ‰€æœ‰åˆ†æ”¯ä¸Šçš„ work ä¹‹åï¼ŒReact æ‰ä¼šç»“æŸçˆ¶èŠ‚ç‚¹ä¸Šçš„ work ç„¶åå†è¿›è¡Œå›æº¯çš„å·¥ä½œã€‚** 

ä»ä¸Šé¢çš„å®ç°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ**`performUnitOfWork`** ä¸ **`completeUnitOfWork`** å‡½æ•°ä¸»è¦ç”¨äºè¿­ä»£ã€‚è€ŒçœŸæ­£çš„æ´»åŠ¨å‘ç”Ÿåœ¨ **`beginWork`** å’Œ **`completeWork`** å‡½æ•°ä¸­ã€‚åœ¨æœ¬ç³»åˆ—å‰©ä¸‹çš„æ–‡ç« ä¸­æˆ‘ä»¬ä¼šäº†è§£åˆ°å½“ React æ‰§è¡Œ **`beginWork`** ä¸ **`completeWork`** æ—¶æˆ‘ä»¬çš„ **`ClickCounter`** ç»„ä»¶å’Œ **`span`** èŠ‚ç‚¹å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆã€‚

###  Commit é˜¶æ®µ

è¿™ä¸ªé˜¶æ®µä»¥è°ƒç”¨ [completeRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L2306) å‡½æ•°ä½œä¸ºå¼€å§‹ã€‚åœ¨è¿™ä¸ªé˜¶æ®µ React ä¼šæ‰§è¡Œæ›´æ–° DOM çš„æ“ä½œä»¥åŠè°ƒç”¨å¯å¼•èµ·çªå˜çš„ pre ä¸ post é’©å­ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

åœ¨ React è¿›å…¥è¿™ä¸ªé˜¶æ®µæ—¶ï¼Œå®ƒæ‹¥æœ‰ç€ä¸¤æ£µæ ‘å’Œ effects åˆ—è¡¨ã€‚ç¬¬ä¸€æ£µæ ‘ä»£è¡¨ç€æ­¤åˆ»åœ¨å±å¹•ä¸Šæ¸²æŸ“çš„çŠ¶æ€ã€‚è€Œå¦ä¸€æ£µåˆ™æ˜¯åœ¨ **`render`** é˜¶æ®µç”Ÿæˆçš„å¤‡ç”¨æ ‘ã€‚åœ¨æºç ä¸­å®ƒé€šå¸¸è¢«å«åš **`finishedWork`** æˆ–è€… **`workInProgress`** æ ‘ã€‚è¯¥å¤‡ç”¨æ ‘ä¸å½“å‰æ ‘ä¸€æ ·ï¼Œé€šè¿‡ **`child`** ä¸ **`sibling`** æŒ‡é’ˆè¿æ¥ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª effects åˆ—è¡¨ â€Šâ€” æ¥è‡ª **`finishedWork`** æ ‘ä¸”é€šè¿‡ **`nextEffect`** æŒ‡é’ˆè¿æ¥çš„ä¸€ç»„èŠ‚ç‚¹å­é›†ã€‚éœ€è¦è®°ä½çš„æ˜¯ effects åˆ—è¡¨æ˜¯æ‰§è¡Œå®Œ **`render`** é˜¶æ®µåçš„ç»“æœã€‚æ¸²æŸ“çš„æœ€ç»ˆç›®çš„æ˜¯è¦ç¡®å®šå“ªäº› DOM èŠ‚ç‚¹åº”è¯¥è¢«æ’å…¥ã€æ›´æ–°æˆ–è€…åˆ é™¤ï¼Œå“ªäº›ç»„ä»¶ä¸Šçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•éœ€è¦è¢«è°ƒç”¨ã€‚è¿™ä¾¿æ˜¯ effects åˆ—è¡¨è¦å‘Šè¯‰æˆ‘ä»¬çš„ä¸œè¥¿ï¼Œ**åŒæ—¶å®ƒä»¬ä¹Ÿæ˜¯åœ¨ commit é˜¶æ®µå°†ä¼šè¢«è¿­ä»£çš„èŠ‚ç‚¹é›†ã€‚** 

> ***å‡ºäºæ–¹ä¾¿è°ƒè¯•çš„ç›®çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ fiber root ä¸Šçš„ `current` å±æ€§æ‹¿åˆ°  `current` æ ‘ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½é€šè¿‡åœ¨ `current` æ ‘ä¸­ `HostFiber` ä¸Šçš„ `alternate` å±æ€§æ‹¿åˆ° `finishedWork` æ ‘ã€‚***

åœ¨ commit é˜¶æ®µä¸»è¦è¿è¡Œçš„å‡½æ•°æ˜¯ [commitRoot](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L523) ã€‚

å®ƒå¤§è‡´ä¼šæ‰§è¡Œä»¥ä¸‹çš„å·¥ä½œï¼š

* åœ¨æ ‡æœ‰ **`Snapshot`** effect çš„èŠ‚ç‚¹ä¸Šè°ƒç”¨ **`getSnapshotBeforeUpdate`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚
* åœ¨æ ‡æœ‰ **`Deletion`** effect çš„èŠ‚ç‚¹ä¸Šè°ƒç”¨ **`componentWillUnmount`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚
* æ‰§è¡Œ DOM çš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚
* å°† **`finishedWork`** æ ‘æ ‡è®°ä¸º **`current`** æ ‘ã€‚
* åœ¨æ ‡æœ‰ **`Placement`** effect çš„èŠ‚ç‚¹ä¸Šè°ƒç”¨ **`componentDidUpdate`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

åœ¨è°ƒç”¨çªå˜å‰çš„ **`getSnapshotBeforeUpdate`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•åï¼ŒReact ä¼šæäº¤æ ‘ä¸­äº§ç”Ÿçš„æ‰€æœ‰å‰¯ä½œç”¨ã€‚å®ƒå°†é€šè¿‡ä¸¤è½®è¿›è¡Œï¼Œç¬¬ä¸€è½®ä¼šæ‰§è¡Œæ‰€æœ‰ DOM (host) çš„æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ä»¥åŠ ref çš„å¸è½½ã€‚ä¹‹å React ä¼šæŠŠ **`finishedWork`** æ ‘äº¤ç»™ **`FiberRoot`** å¹¶å°† **`workInProgress`** æ ‘æ ‡è®°ä¸º **`current`** æ ‘ã€‚è¿™æ˜¯åœ¨ commit é˜¶æ®µçš„ç¬¬ä¸€è½®ä¹‹åè¦å®Œæˆçš„å·¥ä½œï¼Œè¿™æ ·åœ¨è°ƒç”¨ **`componentWillUnmount`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ—¶å¼•ç”¨çš„ä»ç„¶æ˜¯å…ˆå‰çš„é‚£æ£µ **`current`** æ ‘ï¼Œä½†åœ¨ commit é˜¶æ®µçš„ç¬¬äºŒè½®å¼€å§‹ä¹‹å‰ï¼Œ**`finishedWork`** æ ‘å·²ç»è¢«æ ‡è®°ä¸º **`current`** æ ‘ï¼Œå› æ­¤åœ¨è°ƒç”¨ **`componentDidMount/Update`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ—¶å¼•ç”¨çš„å°±æ˜¯æœ€æ–°çš„ **`current`** æ ‘ã€‚åœ¨ç¬¬äºŒè½®è¿›è¡Œçš„æ—¶å€™ï¼ŒReact ä¼šè°ƒç”¨æ‰€æœ‰å…¶ä»–çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»¥åŠ ref ç›¸å…³çš„å›è°ƒã€‚è¿™äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¢«æ”¾åœ¨å•ç‹¬çš„ä¸€è½®ä¸­è¿›è¡Œä¸ºçš„å°±æ˜¯ç¡®ä¿åœ¨è¿™ä¹‹å‰æ ‘ä¸­æ‰€æœ‰çš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œéƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚

ä¸‹é¢æ˜¯ä¸Šè¿°æ­¥éª¤ä¸­å‡½æ•°è¿è¡Œçš„é‡ç‚¹ï¼š

```js
function commitRoot(root, finishedWork) {
    commitBeforeMutationLifecycles()
    commitAllHostEffects();
    root.current = finishedWork;
    commitAllLifeCycles();
}
```

ä»£ç ä¸­çš„æ¯ä¸€ä¸ªå­å‡½æ•°éƒ½å®ç°äº†ç”¨äºéå† effects åˆ—è¡¨å¹¶æŸ¥çœ‹ç›¸åº” effects ç±»å‹çš„æ–¹æ³•ï¼Œå½“å‘ç°ä¸è¯¥å‡½æ•°ç›®çš„ç›¸å…³çš„ effect æ—¶ï¼ŒReact ä¾¿ä¼šç«‹åˆ»è°ƒç”¨å®ƒã€‚

#### çªå˜å‰çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç ä¼šéå†æ•´ä¸ª effects æ ‘å¹¶æ£€æŸ¥æŸä¸ªå¸¦æœ‰ **`Snapshot`** effect çš„èŠ‚ç‚¹ï¼š

```js
function commitBeforeMutationLifecycles() {
    while (nextEffect !== null) {
        const effectTag = nextEffect.effectTag;
        if (effectTag & Snapshot) {
            const current = nextEffect.alternate;
            commitBeforeMutationLifeCycles(current, nextEffect);
        }
        nextEffect = nextEffect.nextEffect;
    }
}
```

å¯¹äº class ç»„ä»¶æ¥è®²ï¼Œè¿™é‡Œçš„ effect å°±ä»£è¡¨ç€è°ƒç”¨ **`getSnapshotBeforeUpdate`** ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

#### DOM çš„æ›´æ–°

[commitAllHostEffects](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376) å‡½æ•°æ˜¯ React æ‰§è¡Œ DOM æ›´æ–°çš„åœ°æ–¹ã€‚è¯¥å‡½æ•°åŸºæœ¬ä¸Šå®šä¹‰äº†éœ€è¦ä¸ºèŠ‚ç‚¹å®Œæˆå’Œæ‰§è¡Œçš„æ“ä½œç±»å‹ï¼š

```js
function commitAllHostEffects() {
    switch (primaryEffectTag) {
        case Placement: {
            commitPlacement(nextEffect);
            ...
        }
        case PlacementAndUpdate: {
            commitPlacement(nextEffect);
            commitWork(current, nextEffect);
            ...
        }
        case Update: {
            commitWork(current, nextEffect);
            ...
        }
        case Deletion: {
            commitDeletion(nextEffect);
            ...
        }
    }
}
```

æœ‰è¶£çš„æ˜¯ï¼ŒReact æŠŠè°ƒç”¨ **`componentWillUnmount`** çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä½œä¸ºäº† **`commitDeletion`** å‡½æ•°ä¸­å¤„ç†åˆ é™¤æ“ä½œçš„ä¸€éƒ¨åˆ†æ¥è¿›è¡Œã€‚

#### çªå˜åçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

[commitAllLifecycles](https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L465) å‡½æ•°åˆ™æ˜¯ React è°ƒç”¨å‰©ä¸‹çš„åƒ **`componentDidUpdate`** å’Œ **`componentDidMount`** ç­‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„åœ°æ–¹ã€‚

